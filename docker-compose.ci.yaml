# Docker Compose override for CI integration tests
# Usage: docker compose -f docker-compose.yaml -f docker-compose.ci.yaml up
#
# This file overrides production config with test-specific settings:
# - Uses Vault dev mode with test root token
# - Mounts CI test data and scripts
# - Exposes ports for debugging
# - Includes test runner services

services:
  # Override mariadb with test configuration
  mariadb:
    command: --innodb-use-native-aio=1 # Required for GHA runners
    ports:
      - "3306:3306"

  # Override vault with dev mode for testing
  vault:
    command:
      - "server"
      - "-dev"
      - "-dev-root-token-id=test-root-token"
      - "-config=/etc/vault/server.hcl"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: test-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_LOG_LEVEL: debug
      VAULT_LOG_REQUESTS_LEVEL: debug
    volumes:
      - vault-data:/vault/data:rw
      - ./conf/vault/local.hcl:/etc/vault/server.hcl:r
    ports:
      - "8200:8200"

  # Vault initialization service for CI
  vault-init:
    image: hashicorp/vault:1.21@sha256:f4e2687b72858a9e2160c344c9fa1ef74c07f21a89a8c00534ab64d3f187b927
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: test-root-token
    depends_on:
      vault:
        condition: service_healthy
    volumes:
      - ./ci/testdata/vault-init.sh:/vault-init.sh:ro
    entrypoint: ["/bin/sh", "/vault-init.sh"]
    restart: no

  # Override api with test configuration
  api:
    environment:
      API_BASE_URL: http://traefik:80
      DASH_BASE_URL: https://localhost:8080
      VAULT_ADDR: http://vault:8200
      LOG_LEVEL: DEBUG
      LIBOPS_ENV: development
      CUSTOMER_VAULT_ADDR: http://vault:8200
      CUSTOMER_VAULT_TOKEN: test-root-token
      DISABLE_BILLING: "true" # Disable Stripe billing for tests
      PUBSUB_EMULATOR_HOST: pubsub:8085
    ports:
      - "8080:8080"

  # Enable vault-agent in local dev with token file auth
  vault-agent:
    environment:
      ENVIRONMENT: local
      VAULT_ADDR: http://vault:8200
    volumes:
      - vault-secrets:/vault/secrets:rw
      - ./ci/vault-root-token:/tmp/vault-root-token:ro

  docs:
    profiles: [disabled]

  # Override traefik for CI (simpler config)
  traefik:
    ports:
      - "80:80"

  # PubSub Emulator for events
  pubsub:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud beta emulators pubsub start --project=libops-api --host-port=0.0.0.0:8085
    ports:
      - "8085:8085"
    networks:
      - default

  event-router:
    environment:
      PUBSUB_EMULATOR_HOST: pubsub:8085
    depends_on:
      - pubsub

  # Test runner service
  test-runner:
    build:
      context: .
      dockerfile: ci/Dockerfile.test
    networks:
      - default
    environment:
      API_URL: http://api:8080
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: test-root-token
      MARIADB_PASSWORD_FILE: /run/secrets/MARIADB_PASSWORD
      # DATABASE_URL will be constructed by entrypoint if MARIADB_PASSWORD_FILE is set
    secrets:
      - source: MARIADB_PASSWORD
    depends_on:
      api:
        condition: service_healthy
    command: ["run-tests"]
    working_dir: /app/ci/test-runner

  # Chrome headless for dashboard E2E tests
  chrome:
    image: chromedp/headless-shell:stable
    networks:
      - default
    ports:
      - "9222:9222"
    cap_add:
      - SYS_ADMIN
    shm_size: 2gb

  # Dashboard E2E test service
  dash-tests:
    build:
      context: .
      dockerfile: ci/Dockerfile.dash-tests
    networks:
      - default
    environment:
      DASHBOARD_URL: http://api:8080
      HEADLESS: "true"
    depends_on:
      api:
        condition: service_healthy
    command: ["run-tests"]
    working_dir: /app/ci/dash-tests

  seed:
    image: mariadb:12.1.2@sha256:e1bcd6f85781f4a875abefb11c4166c1d79e4237c23de597bf0df81fec225b40
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/MARIADB_ROOT_PASSWORD
      MARIADB_PASSWORD_FILE: /run/secrets/MARIADB_PASSWORD
      MARIADB_USER: libops
      MARIADB_DATABASE: libops
    networks:
      - default
    secrets:
      - source: MARIADB_ROOT_PASSWORD
      - source: MARIADB_PASSWORD
    volumes:
      - ./ci/testdata:/testdata:ro
    entrypoint: /testdata/import.sh
    depends_on:
      api:
        condition: service_healthy
    profiles: [none]