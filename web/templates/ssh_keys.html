{{template "base" .}}

{{define "title"}}SSH Keys - LibOps{{end}}

{{define "content"}}
<!-- Page Header -->
<div class="mb-8 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 mb-1">SSH Keys</h1>
        <p class="text-sm text-gray-600">Manage your SSH keys for secure access</p>
    </div>
    <button onclick="openCreateSSHKeyModal()"
        class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
        Add SSH Key
    </button>
</div>

<!-- SSH Keys List -->
<div id="ssh-keys-container">
    <div class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
    </div>
</div>

<!-- Add SSH Key Modal -->
<div id="create-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">Add SSH Key</h2>
            <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="create-ssh-key-form" class="p-6">
            <div class="space-y-4">
                <div>
                    <label for="key-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="key-name" name="name" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                        placeholder="My Laptop">
                    <p class="mt-1 text-xs text-gray-500">A descriptive name for this SSH key</p>
                </div>
                <div>
                    <label for="public-key" class="block text-sm font-medium text-gray-700 mb-1">Public Key</label>
                    <textarea id="public-key" name="public_key" required rows="5"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 font-mono text-xs"
                        placeholder="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... user@example.com"></textarea>
                    <p class="mt-1 text-xs text-gray-500">Paste your SSH public key (usually found in ~/.ssh/id_rsa.pub or ~/.ssh/id_ed25519.pub)</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeCreateModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                    class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
                    Add Key
                </button>
            </div>
        </form>
    </div>
</div>

{{end}}

{{define "scripts"}}
<script>
// Get account ID from server-side template
const ACCOUNT_ID = '{{.AccountID}}';

// Load SSH keys on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSSHKeys();
});

async function loadSSHKeys() {
    try {
        const keys = await window.sshKeys.listSSHKeys(ACCOUNT_ID);
        renderSSHKeys(keys || []);
    } catch (error) {
        console.error('Error loading SSH keys:', error);
        document.getElementById('ssh-keys-container').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                <p class="text-sm text-red-800">Failed to load SSH keys. Please try again.</p>
            </div>
        `;
    }
}

function renderSSHKeys(sshKeys) {
    const container = document.getElementById('ssh-keys-container');

    if (sshKeys.length === 0) {
        container.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 mb-4">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M13.5 1a1.5 1.5 0 0 1 1.5 1.5v11a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5v-11A1.5 1.5 0 0 1 2.5 1h11zM2.5 0a2.5 2.5 0 0 0-2.5 2.5v11A2.5 2.5 0 0 0 2.5 16h11a2.5 2.5 0 0 0 2.5-2.5v-11A2.5 2.5 0 0 0 13.5 0h-11z"/>
                        <path d="M5 4.002h6v1h-6v-1zm0 3h6v1H5v-1zm0 3h4v1H5v-1z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No SSH keys yet</h3>
                <p class="text-sm text-gray-600 mb-4">Add your first SSH key for secure access</p>
                <button onclick="openCreateSSHKeyModal()"
                    class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
                    Add SSH Key
                </button>
            </div>
        `;
        return;
    }

    let html = `
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fingerprint</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key Type</th>
                        <th class="px-6 py-3"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
    `;

    sshKeys.forEach(key => {
        const keyType = extractKeyType(key.public_key);
        const fingerprint = key.fingerprint || 'N/A';
        const shortFingerprint = fingerprint.length > 40 ? fingerprint.substring(0, 40) + '...' : fingerprint;

        html += `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900">${escapeHtml(key.name || 'Unnamed Key')}</div>
                </td>
                <td class="px-6 py-4">
                    <code class="text-xs text-gray-600" title="${escapeHtml(fingerprint)}">${escapeHtml(shortFingerprint)}</code>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        ${keyType}
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <button onclick="deleteSSHKey('${key.key_id}')"
                        class="text-red-600 hover:text-red-800 text-sm font-medium">
                        Delete
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function extractKeyType(publicKey) {
    if (!publicKey) return 'Unknown';
    if (publicKey.startsWith('ssh-rsa')) return 'RSA';
    if (publicKey.startsWith('ssh-ed25519')) return 'ED25519';
    if (publicKey.startsWith('ecdsa-sha2-')) return 'ECDSA';
    return 'Unknown';
}

function openCreateSSHKeyModal() {
    document.getElementById('create-modal').classList.remove('hidden');
}

function closeCreateModal() {
    document.getElementById('create-modal').classList.add('hidden');
    document.getElementById('create-ssh-key-form').reset();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle create form submission
document.getElementById('create-ssh-key-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const name = formData.get('name');
    const publicKey = formData.get('public_key').trim();

    try {
        await window.sshKeys.createSSHKey(ACCOUNT_ID, publicKey, name);
        closeCreateModal();
        loadSSHKeys(); // Reload the list
    } catch (error) {
        console.error('Error adding SSH key:', error);
        alert('Failed to add SSH key: ' + error.message);
    }
});

async function deleteSSHKey(keyId) {
    if (!confirm('Are you sure you want to delete this SSH key? This action cannot be undone.')) {
        return;
    }

    try {
        await window.sshKeys.deleteSSHKey(ACCOUNT_ID, keyId);
        loadSSHKeys(); // Reload the list
    } catch (error) {
        console.error('Error deleting SSH key:', error);
        alert('Failed to delete SSH key: ' + error.message);
    }
}
</script>
{{end}}
