<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to LibOps</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 px-4 py-12">
    <div class="max-w-3xl mx-auto">
        <!-- Logo -->
        <div class="flex justify-center mb-8">
            <img src="/static/img/logo.png" alt="LibOps" class="h-12 w-auto">
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="relative">
                <div class="overflow-hidden h-2 text-xs flex rounded-full bg-white shadow-sm">
                    <div id="progress-bar"
                        class="transition-all duration-500 flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-indigo-600"
                        style="width: 14%"></div>
                </div>
            </div>
            <div class="mt-3 text-sm text-gray-700 text-center font-medium">
                Step <span id="current-step">1</span> of 7
            </div>
        </div>

        <!-- Onboarding Card -->
        <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
            <div id="onboarding-content" class="p-8 md:p-12">
                <!-- Steps will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-sm text-gray-600">
            Need help? <a href="mailto:support@libops.io" class="text-blue-600 hover:text-blue-700">Contact Support</a>
        </div>
    </div>

    <script type="module">
        class OnboardingFlow {
            constructor() {
                this.currentStep = 1;
                this.sessionData = {};
                this.apiBase = '/api/onboarding';
                this.pollInterval = null;
                // Store IDs for API calls
                this.organizationId = null;
                this.projectId = null;
            }

            async init() {
                await this.loadSession();
                this.renderStep(this.currentStep);
            }

            async loadSession() {
                try {
                    const response = await fetch(`${this.apiBase}/session`);
                    if (response.ok) {
                        const data = await response.json();
                        this.sessionData = data;
                        this.currentStep = data.current_step || 1;

                        // Restore organization_id if available from session
                        if (data.organization_public_id) {
                            this.organizationId = data.organization_public_id;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load session:', error);
                }
            }

            startPolling() {
                // Poll every 2 seconds to check if payment completed
                this.pollInterval = setInterval(async () => {
                    await this.loadSession();
                    // If we've advanced past step 3, stop polling and re-render
                    if (this.currentStep > 3) {
                        this.stopPolling();
                        this.renderStep(this.currentStep);
                    }
                }, 2000);
            }

            stopPolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
            }

            async renderStep(step) {
                // Stop any existing polling when changing steps
                this.stopPolling();

                this.currentStep = step;
                this.updateProgress();

                const content = document.getElementById('onboarding-content');

                switch (step) {
                    case 1:
                        content.innerHTML = this.renderStep1();
                        this.attachStep1Handlers();
                        break;
                    case 2:
                        content.innerHTML = this.renderStep2();
                        this.attachStep2Handlers();
                        break;
                    case 3:
                        content.innerHTML = this.renderStep3();
                        // Start polling to detect when payment completes
                        this.startPolling();
                        break;
                    case 4:
                        content.innerHTML = this.renderStep4();
                        this.attachStep4Handlers();
                        break;
                    case 5:
                        content.innerHTML = this.renderStep5();
                        this.attachStep5Handlers();
                        break;
                    case 6:
                        content.innerHTML = this.renderStep6();
                        this.attachStep6Handlers();
                        break;
                    case 7:
                        content.innerHTML = this.renderStep7();
                        this.attachStep7Handlers();
                        break;
                }
            }

            renderStep1() {
                return `
                    <div class="max-w-md mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Welcome to LibOps! ðŸŽ‰</h2>
                        <p class="text-gray-600 mb-8">
                            Let's get your organization set up. You'll be able to create projects and invite teammates to collaborate.
                        </p>
                        <form id="step1-form" class="space-y-6">
                            <div>
                                <label for="org-name" class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                                <input
                                    type="text"
                                    id="org-name"
                                    name="organization_name"
                                    placeholder="Acme Inc."
                                    value="${this.sessionData.org_name || ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                                <p class="mt-2 text-xs text-gray-500">This is typically your company or team name</p>
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition-all shadow-md hover:shadow-lg">
                                Continue
                            </button>
                        </form>
                    </div>
                `;
            }

            renderStep2() {
                const diskSize = this.sessionData.disk_size_gb || 20;
                const diskPrice = (diskSize * 0.10).toFixed(2);

                return `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Choose Your Plan</h2>
                        <p class="text-gray-600 mb-8">
                            Select compute power and storage for your projects. <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">7-day free trial</span>
                        </p>
                        <form id="step2-form" class="space-y-6">
                            <!-- Machine Type Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Machine Size</label>
                                <div class="space-y-3">
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                        <input type="radio" name="machine_type" value="e2-medium" class="mr-4 text-blue-600 focus:ring-blue-500" required />
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">Small</div>
                                            <div class="text-sm text-gray-600">1 vCPU, 4 GiB RAM</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-gray-900">$125</div>
                                            <div class="text-sm text-gray-500">/month</div>
                                        </div>
                                    </label>

                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                        <input type="radio" name="machine_type" value="n4-standard-2" class="mr-4 text-blue-600 focus:ring-blue-500" required />
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">Medium</div>
                                            <div class="text-sm text-gray-600">2 vCPU, 8 GiB RAM</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-gray-900">$290</div>
                                            <div class="text-sm text-gray-500">/month</div>
                                        </div>
                                    </label>

                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                        <input type="radio" name="machine_type" value="n4-standard-4" class="mr-4 text-blue-600 focus:ring-blue-500" required />
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">Large</div>
                                            <div class="text-sm text-gray-600">4 vCPU, 16 GiB RAM</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-gray-900">$550</div>
                                            <div class="text-sm text-gray-500">/month</div>
                                        </div>
                                    </label>

                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                        <input type="radio" name="machine_type" value="n4-standard-8" class="mr-4 text-blue-600 focus:ring-blue-500" required />
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">XLarge</div>
                                            <div class="text-sm text-gray-600">8 vCPU, 32 GiB RAM</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-gray-900">$1000</div>
                                            <div class="text-sm text-gray-500">/month</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Disk Size Slider -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Disk Storage: <span id="disk-size-display" class="font-bold text-blue-600">${diskSize}</span> GB
                                    <span class="text-gray-500">($<span id="disk-price-display">${diskPrice}</span>/month)</span>
                                </label>
                                <input
                                    type="range"
                                    id="disk-size"
                                    name="disk_size_gb"
                                    min="10"
                                    max="2000"
                                    value="${diskSize}"
                                    step="10"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                />
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10 GB</span>
                                    <span>2000 GB</span>
                                </div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-900">
                                    <svg class="inline w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    7-day free trial included. No charge during trial. Cancel anytime.
                                </p>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition-all shadow-md hover:shadow-lg">
                                Continue to Payment
                            </button>
                        </form>
                    </div>
                `;
            }

            renderStep3() {
                const checkoutLink = this.sessionData.stripe_checkout_url
                    ? `<p class="mt-6">
                           <a href="${this.sessionData.stripe_checkout_url}"
                              class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                               Complete Payment in Stripe
                           </a>
                       </p>
                       <p class="text-sm text-gray-500 mt-3">Payment not completing? Click the button above to return to checkout.</p>`
                    : '';

                return `
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-6"></div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">Processing Payment...</h2>
                        <p class="text-gray-600">Setting up your subscription. This will only take a moment.</p>
                        ${checkoutLink}
                    </div>
                `;
            }

            renderStep4() {
                return `
                    <div class="max-w-md mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Create Your First Project</h2>
                        <p class="text-gray-600 mb-8">
                            Projects organize your deployments and environments.
                        </p>
                        <form id="step4-form" class="space-y-6">
                            <div>
                                <label for="project-name" class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                <input
                                    type="text"
                                    id="project-name"
                                    name="project_name"
                                    placeholder="My Website"
                                    value="${this.sessionData.project_name || ''}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition-all shadow-md hover:shadow-lg">
                                Continue
                            </button>
                        </form>
                    </div>
                `;
            }

            renderStep5() {
                return `
                    <div class="max-w-md mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Select Deployment Region</h2>
                        <p class="text-gray-600 mb-8">
                            Choose where your project will be hosted.
                        </p>
                        <form id="step5-form" class="space-y-6">
                            <div>
                                <label for="country" class="block text-sm font-medium text-gray-700 mb-2">Country/Region</label>
                                <select id="country" name="country" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">Select a region...</option>
                                    <option value="us">United States</option>
                                    <option value="ca">Canada</option>
                                    <option value="eu">Europe</option>
                                    <option value="asia">Asia Pacific</option>
                                    <option value="au">Australia</option>
                                    <option value="sa">South America</option>
                                </select>
                            </div>

                            <div>
                                <label for="region" class="block text-sm font-medium text-gray-700 mb-2">Specific Location</label>
                                <select id="region" name="region" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-100" required disabled>
                                    <option value="">Select a country first...</option>
                                </select>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition-all shadow-md hover:shadow-lg">
                                Continue
                            </button>
                        </form>
                    </div>
                `;
            }

            renderStep6() {
                return `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Configure Your Site</h2>
                        <p class="text-gray-600 mb-8">
                            Set up your site name, port, and GitHub repository.
                        </p>
                        <form id="step6-form" class="space-y-6">
                            <div>
                                <label for="site-name" class="block text-sm font-medium text-gray-700 mb-2">Site Name</label>
                                <input
                                    type="text"
                                    id="site-name"
                                    name="site_name"
                                    placeholder="production"
                                    value="${this.sessionData.site_name || 'production'}"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                            </div>

                            <div>
                                <label for="port" class="block text-sm font-medium text-gray-700 mb-2">Port</label>
                                <input
                                    type="number"
                                    id="port"
                                    name="port"
                                    placeholder="80"
                                    value="${this.sessionData.port || 80}"
                                    min="1"
                                    max="65535"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                                <p class="mt-2 text-xs text-gray-500">Port your application listens on (default: 80)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">GitHub Repository</label>
                                <div class="space-y-3">
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                <input type="radio" name="repo_option" value="ojs" class="mr-3 mt-1 text-blue-600 focus:ring-blue-500" required />
                                <div>
                                    <div class="font-semibold text-gray-900">Open Journal Systems (OJS)</div>
                                    <div class="text-sm text-gray-600">github.com/libops/ojs</div>
                                </div>
                            </label>

                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                <input type="radio" name="repo_option" value="isle-site-template" class="mr-3 mt-1 text-blue-600 focus:ring-blue-500" required />
                                <div>
                                    <div class="font-semibold text-gray-900">ISLE Site Template</div>
                                    <div class="text-sm text-gray-600">github.com/libops/isle-site-template</div>
                                </div>
                            </label>

                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                <input type="radio" name="repo_option" value="new-from-template" class="mr-3 mt-1 text-blue-600 focus:ring-blue-500" />
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">Create New from Template</div>
                                    <div class="text-sm text-gray-600 mb-2">Create a new repository from ISLE template</div>
                                    <a href="https://github.com/libops/isle-site-template/generate" target="_blank" class="inline-flex items-center text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200 transition-colors">
                                        Open GitHub to Create â†’
                                    </a>
                                </div>
                            </label>

                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                <input type="radio" name="repo_option" value="custom" class="mr-3 mt-1 text-blue-600 focus:ring-blue-500" />
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 mb-2">Custom Repository</div>
                                    <input
                                        type="url"
                                        id="custom-url"
                                        name="custom_url"
                                        placeholder="https://github.com/username/repo"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                        disabled
                                    />
                                </div>
                            </label>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition-all shadow-md hover:shadow-lg">
                                Continue
                            </button>
                        </form>
                    </div>
                `;
            }

            renderStep7() {
                return `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Final Configuration</h2>
                        <p class="text-gray-600 mb-8">
                            Configure firewall access and optionally add your SSH keys.
                        </p>
                        <form id="step7-form" class="space-y-6">
                            <div>
                                <label for="firewall-ip" class="block text-sm font-medium text-gray-700 mb-2">Your IP Address</label>
                                <input
                                    type="text"
                                    id="firewall-ip"
                                    name="firewall_ip"
                                    placeholder="Loading..."
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    required
                                />
                                <p class="mt-2 text-xs text-gray-500">
                                    HTTPS and SSH access will be allowed from this IP
                                </p>
                            </div>

                            <div class="border-t pt-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">SSH Public Keys (Optional)</label>
                                <p class="text-xs text-gray-600 mb-4">
                                    Add your SSH public key to access your site over SSH. You can add more keys later or invite teammates who can bring their own keys.
                                </p>
                                <div id="ssh-keys-container" class="space-y-3">
                                    <div class="ssh-key-input">
                                        <textarea
                                            name="ssh_key_0"
                                            placeholder="ssh-ed25519 AAAAC3Nza... user@laptop (optional)"
                                            rows="2"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                                        ></textarea>
                                    </div>
                                </div>
                                <button type="button" id="add-ssh-key" class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium">
                                    + Add another SSH key
                                </button>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-900">
                                    <svg class="inline w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    Your site is being provisioned and will be ready in ~2 minutes after completion.
                                </p>
                            </div>

                            <button type="submit" id="complete-button" class="w-full bg-gradient-to-r from-red-900 to-red-950 text-white py-3 px-6 rounded-lg hover:from-red-950 hover:to-red-950 font-medium transition-all shadow-md hover:shadow-lg">
                                Complete Setup ðŸŽ‰
                            </button>
                        </form>
                    </div>
                `;
            }

            // Handler implementations
            attachStep1Handlers() {
                const form = document.getElementById('step1-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const organizationName = formData.get('organization_name');

                    // Call CreateOrganization API
                    try {
                        const response = await fetch('/libops.v1.OrganizationService/CreateOrganization', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                folder: {
                                    organization_name: organizationName
                                }
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            alert(error.message || 'Failed to create organization');
                            return;
                        }

                        const result = await response.json();
                        // Handle both snake_case (standard Go JSON) and camelCase (proto JSON)
                        // Try nested organization object first, then top-level fields
                        this.organizationId = result.organization?.organization_id ||
                                            result.organization?.organizationId ||
                                            result.organization_id ||
                                            result.organizationId;

                        if (!this.organizationId) {
                            throw new Error('Failed to get organization ID from response');
                        }

                        // Update session with org name AND organization public_id
                        await this.submitStep('/api/onboarding/step1', {
                            organization_name: organizationName,
                            organization_public_id: this.organizationId
                        });
                    } catch (error) {
                        console.error('Failed to create organization:', error);
                        alert('Failed to create organization. Please try again.');
                    }
                });
            }

            attachStep2Handlers() {
                const diskSlider = document.getElementById('disk-size');
                const diskDisplay = document.getElementById('disk-size-display');
                const priceDisplay = document.getElementById('disk-price-display');

                diskSlider.addEventListener('input', (e) => {
                    const size = e.target.value;
                    const price = (size * 0.10).toFixed(2);
                    diskDisplay.textContent = size;
                    priceDisplay.textContent = price;
                });

                const form = document.getElementById('step2-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const response = await this.submitStep('/api/onboarding/step2', {
                        machine_type: formData.get('machine_type'),
                        disk_size_gb: parseInt(formData.get('disk_size_gb'))
                    });

                    if (response) {
                        if (response.checkout_url) {
                            // Redirect to Stripe checkout
                            window.location.href = response.checkout_url;
                        } else if (response.skip_billing) {
                            // Billing disabled, advance to next step
                            this.renderStep(response.next_step || 4);
                        }
                    }
                });
            }

            attachStep4Handlers() {
                const form = document.getElementById('step4-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const projectName = formData.get('project_name');

                    // Just save the project name - project will be created after region selection
                    await this.submitStep('/api/onboarding/step4', {
                        project_name: projectName
                    });

                    // Manually advance to next step
                    this.renderStep(this.currentStep + 1);
                });
            }

            attachStep5Handlers() {
                const countrySelect = document.getElementById('country');
                const regionSelect = document.getElementById('region');

                countrySelect.addEventListener('change', async (e) => {
                    const country = e.target.value;
                    if (!country) {
                        regionSelect.disabled = true;
                        regionSelect.innerHTML = '<option value="">Select a country first...</option>';
                        return;
                    }

                    try {
                        const response = await fetch(`/api/onboarding/regions?country=${country}`);
                        const regions = await response.json();

                        regionSelect.innerHTML = '<option value="">Select a location...</option>';
                        regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.Code;
                            option.textContent = region.DisplayName;
                            regionSelect.appendChild(option);
                        });
                        regionSelect.disabled = false;
                        regionSelect.classList.remove('bg-gray-100');
                    } catch (error) {
                        console.error('Failed to load regions:', error);
                    }
                });

                const form = document.getElementById('step5-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = 'Creating project...';

                    try {
                        const formData = new FormData(form);
                        const country = formData.get('country');
                        const region = formData.get('region');

                        // Update session with region first
                        await this.submitStep('/api/onboarding/step5', {
                            country: country,
                            region: region
                        });

                        // Get session data for project name, machine type, and disk size
                        await this.loadSession();

                        // Ensure we have organization ID from session
                        if (!this.organizationId && this.sessionData.organization_public_id) {
                            this.organizationId = this.sessionData.organization_public_id;
                        }

                        // Verify we have organization ID before proceeding
                        if (!this.organizationId) {
                            throw new Error('Organization ID not found. Please go back to step 1.');
                        }

                        // Now create the project via API (we have all required data)
                        const response = await fetch('/libops.v1.ProjectService/CreateProject', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                organization_id: this.organizationId,
                                project: {
                                    project_name: this.sessionData.project_name || 'My Project',
                                    region: region,
                                    zone: region + '-a',
                                    machine_type: this.sessionData.machine_type || 'e2-medium',
                                    disk_size_gb: this.sessionData.disk_size_gb || 20,
                                    create_branch_sites: false
                                }
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Failed to create project');
                        }

                        const result = await response.json();
                        this.projectId = result.project.project_id || result.project.projectId;

                        // Move to next step
                        this.renderStep(6);
                    } catch (error) {
                        console.error('Failed to create project:', error);
                        alert('Failed to create project: ' + error.message + '\nPlease try again.');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Continue';
                    }
                });
            }

            attachStep6Handlers() {
                const repoOptions = document.querySelectorAll('input[name="repo_option"]');
                const customURL = document.getElementById('custom-url');

                repoOptions.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        customURL.disabled = e.target.value !== 'custom';
                        if (e.target.value === 'custom') {
                            customURL.focus();
                        }
                    });
                });

                const form = document.getElementById('step6-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = 'Creating site...';

                    try {
                        const formData = new FormData(form);
                        const siteName = formData.get('site_name');
                        const port = parseInt(formData.get('port')) || 80;
                        const repoOption = formData.get('repo_option');
                        const customUrl = formData.get('custom_url') || '';

                        // Update session first
                        await this.submitStep('/api/onboarding/step6', {
                            site_name: siteName,
                            port: port,
                            repo_option: repoOption,
                            custom_url: customUrl
                        });

                        // Determine GitHub repository URL
                        let githubRepo = '';
                        if (repoOption === 'ojs') {
                            githubRepo = 'https://github.com/pkp/ojs';
                        } else if (repoOption === 'isle-site-template') {
                            githubRepo = 'https://github.com/libops/isle-site-template';
                        } else if (repoOption === 'custom') {
                            githubRepo = customUrl;
                        }

                        // Ensure we have organization and project IDs
                        if (!this.organizationId && this.sessionData.organization_public_id) {
                            this.organizationId = this.sessionData.organization_public_id;
                        }
                        if (!this.organizationId) {
                            throw new Error('Organization ID not found. Please go back to step 1.');
                        }
                        if (!this.projectId) {
                            throw new Error('Project ID not found. Please go back to step 5.');
                        }

                        // Create the site via API
                        const response = await fetch('/libops.v1.SiteService/CreateSite', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                organization_id: this.organizationId,
                                project_id: this.projectId,
                                site: {
                                    site_name: siteName,
                                    github_repository: githubRepo,
                                    github_ref: 'heads/main',
                                    compose_path: '/mnt/disks/data/compose',
                                    compose_file: 'docker-compose.yml',
                                    port: port,
                                    application_type: 'generic',
                                    up_cmd: ['docker compose up --remove-orphans -d'],
                                    init_cmd: [],
                                    rollout_cmd: ['docker compose pull', 'docker compose up --remove-orphans -d']
                                }
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Failed to create site');
                        }

                        const result = await response.json();
                        this.siteId = result.site.site_id || result.site.siteId;

                        // Move to next step
                        this.renderStep(7);
                    } catch (error) {
                        console.error('Failed to create site:', error);
                        alert('Failed to create site: ' + error.message + '\nPlease try again.');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Continue';
                    }
                });
            }

            async attachStep7Handlers() {
                // Fetch and populate IP address
                try {
                    const response = await fetch('/api/onboarding/client-ip');
                    const data = await response.json();
                    const ipInput = document.getElementById('firewall-ip');
                    ipInput.value = data.ip;
                } catch (error) {
                    console.error('Failed to fetch IP:', error);
                }

                // Handle adding SSH keys
                let sshKeyCount = 1;
                const addSSHKeyButton = document.getElementById('add-ssh-key');
                addSSHKeyButton.addEventListener('click', () => {
                    const container = document.getElementById('ssh-keys-container');
                    const newKeyInput = document.createElement('div');
                    newKeyInput.className = 'ssh-key-input flex gap-2';
                    newKeyInput.innerHTML = `
                        <textarea
                            name="ssh_key_${sshKeyCount}"
                            placeholder="ssh-ed25519 AAAAC3Nza... user@laptop (optional)"
                            rows="2"
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                        ></textarea>
                        <button type="button" class="remove-ssh-key text-red-600 hover:text-red-700 px-3">âœ•</button>
                    `;
                    container.appendChild(newKeyInput);

                    // Add remove handler
                    newKeyInput.querySelector('.remove-ssh-key').addEventListener('click', () => {
                        newKeyInput.remove();
                    });

                    sshKeyCount++;
                });

                const form = document.getElementById('step7-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = document.getElementById('complete-button');
                    submitButton.disabled = true;
                    submitButton.textContent = 'Completing setup...';

                    try {
                        const formData = new FormData(form);
                        let firewallIP = formData.get('firewall_ip');

                        // Add /32 if not present (single IP CIDR notation)
                        if (firewallIP && !firewallIP.includes('/')) {
                            firewallIP = firewallIP + '/32';
                        }

                        // Collect SSH keys (filter out empty ones)
                        const sshKeys = [];
                        for (let [key, value] of formData.entries()) {
                            if (key.startsWith('ssh_key_') && value.trim()) {
                                sshKeys.push(value.trim());
                            }
                        }

                        // Ensure we have organization ID
                        if (!this.organizationId && this.sessionData.organization_public_id) {
                            this.organizationId = this.sessionData.organization_public_id;
                        }
                        if (!this.organizationId) {
                            throw new Error('Organization ID not found. Please go back to step 1.');
                        }

                        // Create firewall rule via API
                        submitButton.textContent = 'Creating firewall rule...';
                        const firewallResponse = await fetch('/libops.v1.FirewallService/CreateOrganizationFirewallRule', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                organization_id: this.organizationId,
                                rule_type: 'FIREWALL_RULE_TYPE_HTTPS_ALLOWED',
                                cidr: firewallIP,
                                name: 'Onboarding IP'
                            })
                        });

                        if (!firewallResponse.ok) {
                            const error = await firewallResponse.json();
                            throw new Error('Failed to create firewall rule: ' + (error.message || 'Unknown error'));
                        }

                        // SSH keys are skipped during onboarding - users can add them later in account settings
                        if (sshKeys.length > 0) {
                            console.log(`Skipping ${sshKeys.length} SSH key(s) - can be added later in account settings`);
                        }

                        // Mark onboarding as complete on the backend
                        submitButton.textContent = 'Finalizing...';
                        await this.submitStep('/api/onboarding/step7', {
                            firewall_ip: firewallIP,
                            ssh_keys: sshKeys
                        });

                        // Redirect to dashboard
                        window.location.href = '/dashboard';
                    } catch (error) {
                        console.error('Failed to complete onboarding:', error);
                        alert('Failed to complete setup: ' + error.message + '\nPlease try again.');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Complete Setup ðŸŽ‰';
                    }
                });
            }

            async submitStep(endpoint, data) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        alert(result.error || 'An error occurred');
                        return null;
                    }

                    // Move to next step
                    // Don't auto-advance for steps that handle their own navigation
                    if (endpoint !== '/api/onboarding/step2' &&
                        endpoint !== '/api/onboarding/step4' &&
                        endpoint !== '/api/onboarding/step5' &&
                        endpoint !== '/api/onboarding/step6' &&
                        endpoint !== '/api/onboarding/step7') {
                        this.renderStep(this.currentStep + 1);
                    }

                    return result;
                } catch (error) {
                    console.error('Failed to submit step:', error);
                    alert('Failed to submit. Please try again.');
                    return null;
                }
            }

            updateProgress() {
                const progress = (this.currentStep / 7) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('current-step').textContent = this.currentStep.toString();
            }
        }

        // Initialize onboarding flow
        const onboarding = new OnboardingFlow();
        onboarding.init();

        // Cleanup polling on page unload
        window.addEventListener('beforeunload', () => {
            onboarding.stopPolling();
        });
    </script>
</body>

</html>
